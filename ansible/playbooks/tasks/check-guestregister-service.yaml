---
- name: "Pre-registration: Handle Cloud Guest Register Race Condition"
  block:

    - name: Wait for cloud guest registration to finish in PAYG
      ansible.builtin.command: systemctl show guestregister.service --property=ActiveState --property=Result  # noqa: command-instead-of-module
      register: guestregister_service_state
      until:
        - guestregister_service_state.rc == 0
        - '"ActiveState=inactive" in guestregister_service_state.stdout'
        - '"Result=success" in guestregister_service_state.stdout'
      retries: 60
      delay: 10
      changed_when: false
      failed_when:
        - guestregister_service_state.rc != 0 or '"ActiveState=failed" in guestregister_service_state.stdout'
      when: not to_be_registered

  rescue:
    - name: Get guestregister.service status
      ansible.builtin.command: systemctl status guestregister.service  # noqa command-instead-of-module
      register: guestregister_systemctl_status
      changed_when: false
      failed_when: false

    - name: Get guestregister.service definition
      ansible.builtin.command: systemctl cat guestregister.service # noqa command-instead-of-module
      register: guestregister_service_definition
      changed_when: false
      failed_when: false
      when: guestregister_systemctl_status.failed | default(false)

    - name: Get journalctl for guestregister.service
      ansible.builtin.command: journalctl -u guestregister.service --no-pager
      register: guestregister_logs
      changed_when: false
      failed_when: false

    - name: Extract specific errors from cloudregister log
      ansible.builtin.shell: |
        set -o pipefail
        grep -E "ERROR:|WARNING:|401 Unauthorized|422|Removing (repository artifacts|credentials|repo|service):" /var/log/cloudregister | tail -n 20
      register: tailored_cloudregister_errors
      failed_when: false
      changed_when: false

    - name: Search for Zypper lock in zypper.log
      ansible.builtin.shell: |
        set -o pipefail
        grep "System management is locked by the application with pid" /var/log/zypper.log | tail -n 5
      register: zypper_log_lock_error
      failed_when: false
      changed_when: false

    - name: Check repository state after failure
      ansible.builtin.command: zypper lr -u
      register: zypper_repos_after_fail
      failed_when: false
      changed_when: false

    - name: Check /etc/hosts for SMT entries
      ansible.builtin.command: grep "susecloud.net" /etc/hosts
      register: hosts_smt_entries
      failed_when: false
      changed_when: false

    - name: Test Metadata Service connectivity
      ansible.builtin.uri:
        url: http://169.254.169.254/metadata/instance?api-version=2021-02-01
        headers:
          Metadata: "true"
        timeout: 2
      register: metadata_check
      failed_when: false
      changed_when: false

    - name: Identify racing Zypper PIDs from log
      ansible.builtin.shell: |
        set -o pipefail
        # Extract PIDs involved in lock contention
        PIDS=$(grep "System management is locked by" /var/log/zypper.log | sed -r 's/.*locked by the application with pid ([0-9]+).*/\1/; s/.* \(([0-9]+)\) .*/\1/' | tr ' ' '\n' | sort -u)
        for pid in $PIDS; do
          echo "PID $pid command:"
          grep "($pid) \[zypper\] main.cc(main):143" /var/log/zypper.log | sed -r 's/.*===== (.*) =====/\1/' | head -n 1
        done
      register: racing_pids_discovery
      failed_when: false
      changed_when: false

    - name: Summary of tailored diagnostics
      ansible.builtin.debug:
        msg:
          - "--- Tailored Diagnostics for guestregister.service failure ---"
          - "Cloudregister Errors Summary: {{ tailored_cloudregister_errors.stdout_lines | default('None found') }}"
          - "Zypper Log Lock Errors: {{ zypper_log_lock_error.stdout_lines | default('None found') }}"
          - "Racing PIDs and Commands: {{ racing_pids_discovery.stdout_lines | default('No racing PIDs identified') }}"
          - "Clean-up/Reset detected: {{ 'Removing' in (tailored_cloudregister_errors.stdout | default('')) }}"
          - "SMT entries in /etc/hosts: {{ hosts_smt_entries.stdout_lines | default('Not found') }}"
          - "Metadata Service Reachable: {{ (metadata_check.status == 200) | ternary('YES', 'NO') }}"
          - "Zypper Repos State: {{ zypper_repos_after_fail.stdout_lines | default('None') }}"

    - name: Attempt proactive restart for recovery verification
      ansible.builtin.systemd:
        name: guestregister.service
        state: restarted
      register: restart_attempt
      failed_when: false

    - name: Wait for restart result
      ansible.builtin.command: systemctl show guestregister.service --property=ActiveState --property=Result  # noqa: command-instead-of-module no-changed-when
      register: restart_state
      until: '"ActiveState=inactive" in restart_state.stdout or "ActiveState=failed" in restart_state.stdout'
      retries: 30
      delay: 5
      failed_when: false

    - name: Handle guestregister.service failure with status 1
      when: '"code=exited, status=1" in guestregister_systemctl_status.stdout'
      block:

        - name: Set guestregister ExecStart command fact
          ansible.builtin.set_fact:
            guestregister_exec_start: "{{ guestregister_service_definition.stdout | regex_search('^ExecStart=(.*)$', '\\1') | first | trim }}"
          when: guestregister_service_definition.stdout is defined

        - name: Analyze guestregister service dependencies
          ansible.builtin.command: systemd-analyze critical-chain guestregister.service
          register: guestregister_deps
          changed_when: false
          failed_when: false

        - name: Get guestregister version
          ansible.builtin.command: guestregister --version
          register: guestregister_version
          changed_when: false
          failed_when: false

        - name: Get guestregister package
          ansible.builtin.command: rpm -q cloud-regionsrv-client  # noqa command-instead-of-module
          register: guestregister_package
          changed_when: false
          failed_when: false

    - name: Handle guestregister.service failure with status 67
      when: '"code=exited, status=67" in guestregister_systemctl_status.stdout'
      block:
        - name: Set guestregister service user
          ansible.builtin.set_fact:
            guestregister_user: "{{ guestregister_service_definition.stdout | regex_search('^User=(.*)$', '\\1') | first | trim }}"
          when: guestregister_service_definition.stdout is defined

        - name: Check if guestregister user exists
          ansible.builtin.command: "id {{ guestregister_user }}"
          register: guestregister_user_exists
          changed_when: false
          failed_when: false
          when: guestregister_user is defined and guestregister_user | length > 0

    - name: Check for corrupted registration file
      ansible.builtin.stat:
        path: /etc/zypp/credentials.d/SCCcredentials
      register: scc_credentials_stat

    - name: Check SCCcredentials file
      when:
        - scc_credentials_stat.stat is defined
        - scc_credentials_stat.stat.exists
      block:
        - name: SCCcredentials is empty
          ansible.builtin.debug:
            msg: "SCCcredentials is empty. Please delete the file and re-run registration."
          when: scc_credentials_stat.stat.size == 0

        - name: SCCcredentials has wrong permissions or owner
          ansible.builtin.debug:
            msg: "SCCcredentials has wrong permissions or owner. Expected root:root and 0640, got {{ scc_credentials_stat.stat.pw_name }}:{{ scc_credentials_stat.stat.gr_name }} and {{ scc_credentials_stat.stat.mode }}. Please correct permissions."
          when: >
            scc_credentials_stat.stat.pw_name != 'root' or
            scc_credentials_stat.stat.gr_name != 'root' or
            scc_credentials_stat.stat.mode != '0640'

    - name: "Scan logs for Zypper Lock Error"
      ansible.builtin.set_fact:
        lock_error_log_line: "{{ guestregister_logs.stdout_lines | select('search', 'System management is locked by the application with pid') | list | last | default('') }}"

    - name: "Extract PID from error log"
      ansible.builtin.set_fact:
        locking_pid: "{{ lock_error_log_line | regex_search('pid ([0-9]+)', '\\1') | first }}"
      when: lock_error_log_line | length > 0

    - name: "Get history of the locking PID"
      ansible.builtin.shell: |
        journalctl _PID={{ locking_pid }} --no-pager --lines=50
      register: pid_history
      when: locking_pid is defined
      changed_when: false

    - name: "Report Findings about locked PID"
      ansible.builtin.debug:
        msg:
          - "Lock Error Found: {{ lock_error_log_line | default('None found') }}"
          - "Culprit PID History: {{ pid_history.stdout_lines | default('No history found') }}"

    - name: Fail if guestregister.service is not in the expected state
      ansible.builtin.assert:
        that: false
        fail_msg: "FATAL: guestregister.service is not in the expected state (inactive/success) after retries. Check logs above for details."
